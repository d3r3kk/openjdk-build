parameters:
  linuxContainer: ""
  buildJavaVersion: ""

stages:
  - stage: test_linux_pr
    displayName: "Test Linux PR"
    condition: and(
        or(
          not(variables.TEST_PLATFORMS_AND_STAGES),
          contains(variables.TEST_PLATFORMS_AND_STAGES, 'Linux.pr')
        ),
        succeeded('build_linux_binaries')
      )
    dependsOn: build_linux_binaries

    jobs:
      - job: test_linux_pr_openjdk
        timeoutInMinutes: 120
        displayName: "Test Linux PR OpenJDK"
        pool:
          vmImage: ubuntu-16.04
        container: ${{ parameters.linuxContainer }}
        variables:
          BUILD_LIST: "openjdk"
          TEST_TARGET: "_individual.openjdk"
        strategy:
          matrix:
            jdk_io_math_jre:
              CUSTOMIZED_TESTS: "openjdk:jdk_io|openjdk:jdk_math|openjdk:jdk_math_jre"
              TEST_NAME: "linux pr openjdk_sanity io math jre"
            jdk_net:
              CUSTOMIZED_TESTS: "openjdk:jdk_net"
              TEST_NAME: "linux pr openjdk_sanity net"
            jdk_security1:
              CUSTOMIZED_TESTS: "openjdk:jdk_security1"
              TEST_NAME: "linux pr openjdk_sanity security1"
            jdk_lang:
              CUSTOMIZED_TESTS: "openjdk:jdk_lang"
              TEST_NAME: "linux pr openjdk_sanity lang"
            jdk_nio:
              CUSTOMIZED_TESTS: "openjdk:jdk_nio"
              TEST_NAME: "linux pr openjdk_sanity nio"
            jdk_rmi:
              CUSTOMIZED_TESTS: "openjdk:jdk_rmi"
              TEST_NAME: "linux pr openjdk_sanity rmi"
            jdk_util:
              CUSTOMIZED_TESTS: "openjdk:jdk_util"
              TEST_NAME: "linux pr openjdk_sanity util"
        steps:
          - template: ../steps/shared/pre_test.yml
          - template: ../steps/linux/pre_test.yml
          - template: ../steps/linux/test.yml
          - template: ../steps/shared/post_test.yml
            parameters:
              testFailTaskOnFailedTests: true
              testTestResultsFiles: "**/*.jtr.xml"

      - ${{ if or(eq(parameters.buildJavaVersion, 'jdk8u'), eq(parameters.buildJavaVersion, 'jdk11u')) }}:

        - job: test_linux_pr_perf
          timeoutInMinutes: 120
          displayName: "Test Linux PR Perf"
          pool:
            vmImage: ubuntu-16.04
          container: ${{ parameters.linuxContainer }}
          variables:
            BUILD_LIST: "perf"
            TEST_TARGET: "_sanity.perf"
            TEST_NAME: "linux pr perf_sanity"
          steps:
            - template: ../steps/shared/pre_test.yml
            - template: ../steps/linux/pre_test.yml
            - template: ../steps/linux/test.yml
            - template: ../steps/shared/post_test.yml
              parameters:
                testFailTaskOnFailedTests: true
                testTestResultsFiles: "**/*.tap.xml"

      - job: test_linux_pr_system
        timeoutInMinutes: 120
        displayName: "Test Linux PR System"
        pool:
          vmImage: ubuntu-16.04
        container: ${{ parameters.linuxContainer }}
        strategy:
          matrix:
            "otherLoadTest & mauveLoadTest":
              BUILD_LIST: "system/otherLoadTest,system/mauveLoadTest"
              TEST_TARGET: "_sanity.system"
              TEST_NAME: "linux pr system_sanity otherLoadTest & mauveLoadTest"
            "mathLoadTest & lambdaLoadTest":
              BUILD_LIST: "system/mathLoadTest,system/lambdaLoadTest"
              TEST_TARGET: "_sanity.system"
              TEST_NAME: "linux pr system_sanity mathLoadTest & mauveLlambdaLoadTestoadTest"
            jlm1:
              BUILD_LIST: "system/jlm"
              CUSTOMIZED_TESTS: "system/jlm:MachineInfo|system/jlm:TestJlmRemoteClassAuth|system/jlm:TestJlmRemoteClassNoAuth_SE80_Linux"
              TEST_TARGET: "_individual.system"
              TEST_NAME: "linux pr system_sanity jlm1"
            jlm2:
              BUILD_LIST: "system/jlm"
              CUSTOMIZED_TESTS: "system/jlm:TestJlmRemoteMemoryAuth_SE80_Linux|system/jlm:TestJlmRemoteMemoryNoAuth_SE80_Linux|system/jlm:TestJlmRemoteNotifierProxyAuth"
              TEST_TARGET: "_individual.system"
              TEST_NAME: "linux pr system_sanity jlm2"
        steps:
          - template: ../steps/shared/pre_test.yml
          - template: ../steps/linux/pre_test.yml
          - template: ../steps/linux/test.yml
          - template: ../steps/shared/post_test.yml
            parameters:
              testFailTaskOnFailedTests: true
              testTestResultsFiles: "**/*.tap.xml"
