parameters:
  buildJavaVersion: ""

stages:
  - stage: test_windows_pr
    variables:
      skipComponentGovernanceDetection: true
      BUILD_JAVA_VERSION: ${{ parameters.buildJavaVersion }}
    displayName: "Test Windows PR"
    condition: and(
        or(
          not(variables.TEST_PLATFORMS_AND_STAGES),
          contains(variables.TEST_PLATFORMS_AND_STAGES, 'Windows.pr')
        ),
        succeeded('build_windows_binaries')
      )
    dependsOn: build_windows_binaries

    jobs:
      - job: test_windows_pr_openjdk
        timeoutInMinutes: 720
        displayName: "Test Windows PR OpenJDK"
        pool:
          vmImage: vs2017-win2016
        variables:
          BUILD_LIST: "openjdk"
          TEST_TARGET: "_sanity.openjdk"
          TEST_NAME: "windows pr openjdk_sanity"
        steps:
          - template: ../steps/shared/pre_test.yml
          - template: ../steps/windows/pre_test.yml
          - template: ../steps/windows/test.yml
          - template: ../steps/shared/post_test.yml
            parameters:
              testFailTaskOnFailedTests: true
              testTestResultsFiles: "**/*.jtr.xml"

      - job: test_windows_pr_system
        timeoutInMinutes: 720
        displayName: "Test Windows PR System"
        pool:
          vmImage: vs2017-win2016
        variables:
          BUILD_LIST: "system"
          TEST_TARGET: "_sanity.system"
          TEST_NAME: "windows pr perf_system"
        steps:
          - template: ../steps/shared/pre_test.yml
          - template: ../steps/windows/pre_test.yml
          - template: ../steps/windows/test.yml
          - template: ../steps/shared/post_test.yml
            parameters:
              testFailTaskOnFailedTests: true
              testTestResultsFiles: "**/*.tap.xml"
