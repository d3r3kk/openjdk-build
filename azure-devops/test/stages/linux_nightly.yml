parameters:
  linuxContainer: ""
  buildJavaVersion: ""

stages:
  - stage: test_linux_nightly
    displayName: "Test Linux Nightly"
    condition: and(
        or(
          not(variables.TEST_PLATFORMS_AND_STAGES),
          contains(variables.TEST_PLATFORMS_AND_STAGES, 'Linux.nightly')
        ),
        succeeded('build_linux_binaries')
      )
    dependsOn: build_linux_binaries

    jobs:
      - job: test_linux_nightly_functional
        timeoutInMinutes: 120
        displayName: "Test Linux Nightly Functional"
        pool:
          vmImage: ubuntu-16.04
        container: ${{ parameters.linuxContainer }}
        variables:
            BUILD_LIST: "functional"
            TEST_TARGET: "_special.functional"
            TEST_NAME: "linux nightly functional_special"
        steps:
          - template: ../steps/shared/pre_test.yml
          - template: ../steps/linux/pre_test.yml
          - template: ../steps/linux/test.yml
          - template: ../steps/shared/post_test.yml
            parameters:
              testFailTaskOnFailedTests: true
              testTestResultsFiles: "**/*.tap.xml"

      - ${{ if or(eq(parameters.buildJavaVersion, 'jdk8u'), eq(parameters.buildJavaVersion, 'jdk11u')) }}:

        - job: test_linux_nightly_external
          timeoutInMinutes: 720
          displayName: "Test Linux Nightly External"
          pool:
            vmImage: ubuntu-16.04
          container: ${{ parameters.linuxContainer }}
          variables:
              BUILD_LIST: "external"
              TEST_TARGET: "_sanity.external"
              TEST_NAME: "linux nightly external_sanity"
          steps:
            - template: ../steps/shared/pre_test.yml
            - template: ../steps/linux/pre_test.yml
            - template: ../steps/linux/test.yml
            - template: ../steps/shared/post_test.yml
              parameters:
                testFailTaskOnFailedTests: false
                testTestResultsFiles: "**/*.tap.xml"
