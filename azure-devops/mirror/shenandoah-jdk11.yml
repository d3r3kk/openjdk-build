name: "$(Year:yyyy).$(Month).0.$(BuildID)"

trigger: none

pr: none

schedules:
  # Convert the UTC time to VNC time, so 7AM UTC is 12PM Vancouver time
  # We run this every Tuesday
  - cron: "0 7 * * *"
    displayName: Nightly
    always: true
    branches:
      include:
        - juniper

jobs:
  - job: mirror
    displayName: "Nightly Mirror Job"
    pool:
      vmImage: ubuntu-16.04
    steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: "3.8.0"

      - bash: |
          mkdir -vp /opt/git-hg
          wget -O "/opt/git-hg/git-remote-hg" "https://raw.githubusercontent.com/mnauw/git-remote-hg/master/git-remote-hg"
          chmod ugo+x /opt/git-hg/git-remote-hg
        displayName: "install git-remote-hg"

      - bash: |
          echo "##vso[task.setvariable variable=PATH]/opt/git-hg:${PATH}"
        displayName: "update PATH"

      - bash: |
          git config --global --add http.https://dev.azure.com.extraheader "AUTHORIZATION: bearer $(System.AccessToken)"
          git config --global core.autocrlf input
          git config --global user.email "juniperinfra@microsoft.com"
          git config --global user.name "Juniper Mirror - $BUILD_DEFINITIONNAME"
        env:
          BUILD_DEFINITIONNAME: $(Build.DefinitionName)
        displayName: "git config"

      - checkout: self
        fetchDepth: 1

      - bash: |
          python -m pip install -r ./azure-devops/mirror/scripts/requirements.txt
        displayName: "pip install dependencies"

      - bash: |
          python ./azure-devops/mirror/scripts/main_hg.py --source_git_uri $(SOURCE_GIT_URI) --tar_file_uri $(TAR_FILE_URI) --pat $(PAT) --organization_url $(ORGANIZATION_URL) --project_id ${PROJECT_ID} --repository $(REPOSITORY)
        displayName: "python run script"
        env:
          PAT: $(PAT)
          PROJECT_ID: $(System.TeamProjectId)

      - script: |
          git config --global --unset http.https://dev.azure.com.extraheader
        displayName: "git remove auth header(s)"
        condition: always()
