# Pre build and test template for macOS
#
# @param stage Stage currently running, e.g., "build", "test".
# @param buildJavaVersion Java version to build and test, 
#                         e.g., "jdk", "jdk8u", "jdk11u".

parameters:
  stage: ""
  buildJavaVersion: ""
  jdkBootDir: "/tmp/openjdk"
  javaHomeDir: "/tmp/java"

steps:
  # checkout files of the openjdk repo that uses this template
  - checkout: self

  # Install necessary dependencies
  - script: |
      brew install autoconf
    displayName: "[Pre ${{ parameters.stage }}] Install dependencies"
  
  # Download and extract the corresponding version
  - script: |
      mkdir -p ${{ parameters.jdkBootDir }}
      mkdir -p ${{ parameters.javaHomeDir }}
      wget -O /tmp/openjdk8.tar.gz "https://buildreqs.blob.core.windows.net/java/macOS/jdk8u.tar.gz"
      tar -xzf /tmp/openjdk8.tar.gz --strip-components=3 -C ${{ parameters.javaHomeDir }}
      if [ "${{ parameters.buildJavaVersion }}" == "jdk8u" ]
      then
          wget -O /tmp/openjdk.tar.gz "https://buildreqs.blob.core.windows.net/java/macOS/jdk8u.tar.gz"
      elif [ "${{ parameters.buildJavaVersion }}" == "jdk11u" ]
      then
          wget -O /tmp/openjdk.tar.gz "https://buildreqs.blob.core.windows.net/java/macOS/jdk10u.tar.gz"
      elif [ "${{ parameters.buildJavaVersion }}" == "jdk" ]
      then
          wget -O /tmp/openjdk.tar.gz "https://buildreqs.blob.core.windows.net/java/macOS/jdk13u.tar.gz"
      fi
      tar -xzf /tmp/openjdk.tar.gz --strip-components=3 -C ${{ parameters.jdkBootDir }}
    displayName: "[Pre ${{ parameters.stage }}] Download and install adopt openjdk boot jdk"

  # Set environment variables
  - script: |
      echo "##vso[task.setvariable variable=JDK_BOOT_DIR]${{ parameters.jdkBootDir }}"
      echo "##vso[task.setvariable variable=JAVA_HOME]${{ parameters.javaHomeDir }}"
      echo "##vso[task.setvariable variable=PATH]${{ parameters.jdkBootDir }}/bin;$PATH"
    displayName: "[Pre ${{ parameters.stage }}] Set environment variables"